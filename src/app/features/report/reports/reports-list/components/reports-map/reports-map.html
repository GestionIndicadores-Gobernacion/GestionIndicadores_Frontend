<div class="flex h-full w-full gap-0 relative" style="min-height: 520px;">

    <!-- ═══════════════════════════════════════════════
         PANEL IZQUIERDO — Filtros + Lista municipios
         ═══════════════════════════════════════════════ -->
    <div class="flex flex-col w-64 flex-shrink-0 border-r border-zinc-100 bg-white z-10">

        <!-- Header del panel -->
        <div class="px-4 py-3 border-b border-zinc-100">
            <h3 class="text-xs font-semibold text-zinc-900">Mapa de cobertura</h3>
            <p class="text-[10px] text-zinc-400 mt-0.5">
                {{ totalFilteredReports }} reporte{{ totalFilteredReports !== 1 ? 's' : '' }}
                · {{ filteredMunicipios.length }} municipio{{ filteredMunicipios.length !== 1 ? 's' : '' }}
            </p>
        </div>

        <!-- Filtros -->
        <div class="px-3 py-3 space-y-2 border-b border-zinc-100">

            <!-- Búsqueda municipio -->
            <div class="relative">
                <span class="pointer-events-none absolute inset-y-0 left-2.5 flex items-center">
                    <svg class="w-3 h-3 text-zinc-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-4.35-4.35M17 11A6 6 0 1 1 5 11a6 6 0 0 1 12 0z" />
                    </svg>
                </span>
                <input type="text" [(ngModel)]="searchQuery" (ngModelChange)="onSearch()"
                    placeholder="Buscar municipio..."
                    class="w-full pl-7 pr-3 py-1.5 text-xs border border-zinc-200 rounded-lg
                           focus:outline-none focus:ring-2 focus:ring-zinc-900/10 focus:border-zinc-400
                           placeholder:text-zinc-300 transition-colors" />
            </div>

            <!-- Filtro componente -->
            <div class="relative">
                <span class="pointer-events-none absolute inset-y-0 left-2.5 flex items-center">
                    <svg class="w-3 h-3 text-zinc-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h10M4 18h7" />
                    </svg>
                </span>
                <select [ngModel]="selectedComponentId"
                    (ngModelChange)="onComponentFilter($event === 'null' || $event === null ? null : +$event)"
                    class="w-full appearance-none bg-white border border-zinc-200 rounded-lg
                           pl-7 pr-6 py-1.5 text-xs text-zinc-600
                           focus:outline-none focus:ring-2 focus:ring-zinc-900/10 focus:border-zinc-400
                           cursor-pointer transition-colors">
                    <option [ngValue]="null">Todos los componentes</option>
                    <option *ngFor="let c of availableComponents" [ngValue]="c.id">{{ c.name }}</option>
                </select>
                <span class="pointer-events-none absolute inset-y-0 right-2 flex items-center">
                    <svg class="w-3 h-3 text-zinc-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                    </svg>
                </span>
            </div>

            <!-- Filtro zona -->
            <div class="inline-flex w-full items-center bg-zinc-100 rounded-lg p-0.5">
                <button *ngFor="let z of [['all','Todos'],['Urbana','Urbana'],['Rural','Rural']]"
                    (click)="onZoneFilter(z[0] === 'all' ? 'all' : z[0] === 'Urbana' ? 'Urbana' : 'Rural')"
                    [ngClass]="selectedZone === z[0] ? 'bg-white shadow-sm text-zinc-900' : 'text-zinc-500'"
                    class="flex-1 py-1 text-[10px] font-medium rounded-md transition-colors cursor-pointer text-center">
                    {{ z[1] }}
                </button>
            </div>

            <!-- Limpiar filtros -->
            <button *ngIf="selectedComponentId || selectedZone !== 'all' || searchQuery"
                (click)="clearFilters()"
                class="w-full text-[10px] text-zinc-400 hover:text-zinc-600 transition-colors py-0.5 cursor-pointer">
                ✕ Limpiar filtros
            </button>
        </div>

        <!-- Lista de municipios -->
        <div class="flex-1 overflow-y-auto">
            <div *ngIf="filteredMunicipios.length === 0"
                class="flex flex-col items-center justify-center h-32 gap-2 text-center px-4">
                <p class="text-xs text-zinc-400">Sin municipios para los filtros seleccionados</p>
            </div>

            <button *ngFor="let m of filteredMunicipios"
                (click)="selectMunicipioFromList(m)"
                [ngClass]="selectedMunicipio?.name === m.name
                    ? 'bg-zinc-50 border-r-2 border-zinc-900'
                    : 'hover:bg-zinc-50 border-r-2 border-transparent'"
                class="w-full text-left px-4 py-2.5 transition-colors cursor-pointer flex items-center gap-2.5">

                <!-- Color dot -->
                <span class="w-2.5 h-2.5 rounded-full flex-shrink-0"
                    [style.background-color]="getMunicipioColor(m.totalReports)"></span>

                <div class="flex-1 min-w-0">
                    <p class="text-xs font-medium text-zinc-900 truncate">{{ m.name }}</p>
                    <p class="text-[10px] text-zinc-400">
                        {{ m.totalReports }} reporte{{ m.totalReports !== 1 ? 's' : '' }}
                        <span class="mx-1">·</span>
                        <span class="text-emerald-600">U {{ m.urbana }}</span>
                        <span class="mx-0.5">/</span>
                        <span class="text-indigo-500">R {{ m.rural }}</span>
                    </p>
                </div>

                <span class="text-[10px] font-semibold text-zinc-400 flex-shrink-0">
                    {{ m.byComponent.length }} comp.
                </span>
            </button>
        </div>

        <!-- Leyenda -->
        <div class="px-4 py-3 border-t border-zinc-100">
            <p class="text-[10px] font-semibold text-zinc-400 uppercase tracking-wide mb-1.5">Cobertura</p>
            <div class="flex items-center gap-1">
                <span class="text-[10px] text-zinc-400">Bajo</span>
                <div class="flex-1 h-2 rounded-full"
                    style="background: linear-gradient(to right, #d4f1e9, #6ee7b7, #10b981, #065f46)"></div>
                <span class="text-[10px] text-zinc-400">Alto</span>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════
         MAPA
         ═══════════════════════════════════════════════ -->
    <div class="flex-1 relative">
        <div [id]="MAP_ID" class="w-full h-full" style="min-height: 520px; z-index: 0;"></div>

        <!-- Style picker — esquina superior derecha del mapa -->
        <div class="absolute top-3 right-3 z-[999]">
            <!-- Botón trigger -->
            <button (click)="showStylePicker = !showStylePicker"
                class="flex items-center gap-1.5 bg-white border border-zinc-200 rounded-lg
                       px-2.5 py-1.5 text-xs font-medium text-zinc-600 shadow-sm
                       hover:border-zinc-300 hover:text-zinc-900 transition-colors cursor-pointer">
                <span>{{ getSelectedStyle().icon }}</span>
                <span>{{ getSelectedStyle().label }}</span>
                <svg class="w-3 h-3 text-zinc-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                </svg>
            </button>

            <!-- Dropdown -->
            <div *ngIf="showStylePicker"
                class="absolute right-0 mt-1.5 bg-white border border-zinc-200 rounded-xl shadow-lg overflow-hidden w-36">
                <button *ngFor="let style of MAP_STYLES"
                    (click)="selectMapStyle(style.id)"
                    [ngClass]="selectedStyleId === style.id
                        ? 'bg-zinc-50 text-zinc-900 font-semibold'
                        : 'text-zinc-600 hover:bg-zinc-50'"
                    class="w-full flex items-center gap-2 px-3 py-2 text-xs transition-colors cursor-pointer">
                    <span>{{ style.icon }}</span>
                    <span>{{ style.label }}</span>
                    <svg *ngIf="selectedStyleId === style.id"
                        class="w-3 h-3 text-zinc-900 ml-auto" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor" stroke-width="2.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Placeholder si no hay reportes -->
        <div *ngIf="reports.length === 0"
            class="absolute inset-0 flex flex-col items-center justify-center bg-white/80 backdrop-blur-sm z-10 gap-2">
            <svg class="w-10 h-10 text-zinc-200" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M9 20.25L3.75 12a8.25 8.25 0 1116.5 0L15 20.25a3 3 0 01-6 0z" />
            </svg>
            <p class="text-sm text-zinc-400">Sin reportes con ubicación registrada</p>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════
         PANEL LATERAL DERECHO — Detalle municipio
         ═══════════════════════════════════════════════ -->
    <div *ngIf="selectedMunicipio"
        class="absolute right-0 top-0 bottom-0 w-80 bg-white border-l border-zinc-200 shadow-xl z-20 flex flex-col overflow-hidden">

        <!-- Header -->
        <div class="px-5 py-4 border-b border-zinc-100 flex-shrink-0">
            <div class="flex items-start justify-between">
                <div>
                    <h3 class="text-sm font-semibold text-zinc-900">{{ selectedMunicipio.name }}</h3>
                    <p class="text-[10px] text-zinc-400 mt-0.5">Valle del Cauca · Colombia</p>
                </div>
                <button (click)="closeSidePanel()"
                    class="text-zinc-400 hover:text-zinc-700 transition-colors cursor-pointer p-1 -mr-1">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Stats rápidos -->
            <div class="grid grid-cols-3 gap-2 mt-3">
                <div class="bg-zinc-50 rounded-lg p-2 text-center">
                    <p class="text-base font-bold text-zinc-900">{{ selectedMunicipio.totalReports }}</p>
                    <p class="text-[10px] text-zinc-400">Reportes</p>
                </div>
                <div class="bg-emerald-50 rounded-lg p-2 text-center">
                    <p class="text-base font-bold text-emerald-700">{{ selectedMunicipio.urbana }}</p>
                    <p class="text-[10px] text-emerald-500">Urbana</p>
                </div>
                <div class="bg-indigo-50 rounded-lg p-2 text-center">
                    <p class="text-base font-bold text-indigo-700">{{ selectedMunicipio.rural }}</p>
                    <p class="text-[10px] text-indigo-500">Rural</p>
                </div>
            </div>

            <!-- Barra urbana/rural -->
            <div class="mt-2.5 h-1.5 rounded-full bg-zinc-100 overflow-hidden flex">
                <div class="h-full bg-emerald-400 transition-all duration-500"
                    [style.width.%]="selectedMunicipio.totalReports > 0
                        ? (selectedMunicipio.urbana / selectedMunicipio.totalReports) * 100 : 0">
                </div>
                <div class="h-full bg-indigo-400 transition-all duration-500"
                    [style.width.%]="selectedMunicipio.totalReports > 0
                        ? (selectedMunicipio.rural / selectedMunicipio.totalReports) * 100 : 0">
                </div>
            </div>
            <div class="flex justify-between mt-1">
                <span class="text-[10px] text-emerald-500">
                    {{ selectedMunicipio.totalReports > 0
                        ? ((selectedMunicipio.urbana / selectedMunicipio.totalReports) * 100 | number:'1.0-0')
                        : 0 }}% Urbana
                </span>
                <span class="text-[10px] text-indigo-500">
                    {{ selectedMunicipio.totalReports > 0
                        ? ((selectedMunicipio.rural / selectedMunicipio.totalReports) * 100 | number:'1.0-0')
                        : 0 }}% Rural
                </span>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex border-b border-zinc-100 flex-shrink-0">
            <button *ngFor="let tab of [
                    {id: 'overview', label: 'Componentes'},
                    {id: 'indicators', label: 'Indicadores'},
                    {id: 'reports', label: 'Reportes'}
                ]"
                (click)="activeTab = $any(tab.id)"
                [ngClass]="activeTab === tab.id
                    ? 'border-b-2 border-zinc-900 text-zinc-900 font-semibold'
                    : 'text-zinc-400 hover:text-zinc-600 border-b-2 border-transparent'"
                class="flex-1 py-2.5 text-[11px] transition-colors cursor-pointer text-center">
                {{ tab.label }}
            </button>
        </div>

        <!-- Contenido del tab -->
        <div class="flex-1 overflow-y-auto">

            <!-- TAB: Componentes -->
            <div *ngIf="activeTab === 'overview'" class="p-4 space-y-3">
                <div *ngIf="selectedMunicipio.byComponent.length === 0"
                    class="text-xs text-zinc-400 text-center py-8">Sin datos de componentes</div>

                <div *ngFor="let comp of selectedMunicipio.byComponent"
                    class="bg-zinc-50 rounded-xl p-3">
                    <div class="flex items-center justify-between mb-1.5">
                        <span class="text-xs font-medium text-zinc-800 leading-snug">{{ comp.component_name }}</span>
                        <span class="text-xs font-bold text-zinc-900 ml-2 flex-shrink-0">
                            {{ comp.count }}
                        </span>
                    </div>
                    <!-- Barra de proporción -->
                    <div class="h-1 rounded-full bg-zinc-200 overflow-hidden">
                        <div class="h-full bg-zinc-700 rounded-full transition-all duration-500"
                            [style.width.%]="selectedMunicipio.totalReports > 0
                                ? (comp.count / selectedMunicipio.totalReports) * 100 : 0">
                        </div>
                    </div>
                    <p class="text-[10px] text-zinc-400 mt-1">
                        {{ selectedMunicipio.totalReports > 0
                            ? ((comp.count / selectedMunicipio.totalReports) * 100 | number:'1.0-0')
                            : 0 }}% del total
                    </p>
                </div>
            </div>

            <!-- TAB: Indicadores -->
            <div *ngIf="activeTab === 'indicators'" class="p-4 space-y-2">
                <div *ngIf="selectedMunicipio.indicators.length === 0"
                    class="text-xs text-zinc-400 text-center py-8">
                    Sin indicadores numéricos registrados
                </div>

                <div *ngFor="let ind of selectedMunicipio.indicators"
                    class="flex items-center justify-between py-2 border-b border-zinc-50 last:border-0">
                    <div class="flex-1 min-w-0 pr-3">
                        <p class="text-xs font-medium text-zinc-800 leading-snug">{{ ind.name }}</p>
                        <p class="text-[10px] text-zinc-400 mt-0.5 capitalize">{{ ind.field_type }}</p>
                    </div>
                    <div class="text-right flex-shrink-0">
                        <p class="text-sm font-bold text-zinc-900">{{ ind.total | number }}</p>
                        <p class="text-[10px] text-zinc-400">total</p>
                    </div>
                </div>
            </div>

            <!-- TAB: Reportes -->
            <div *ngIf="activeTab === 'reports'" class="divide-y divide-zinc-50">
                <div *ngFor="let r of selectedMunicipio.reports"
                    class="px-4 py-3 hover:bg-zinc-50 transition-colors">
                    <div class="flex items-start justify-between gap-2">
                        <div class="flex-1 min-w-0">
                            <p class="text-[10px] font-semibold text-zinc-500 uppercase tracking-wide">
                                {{ r.report_date | date:'dd MMM yyyy' }}
                            </p>
                            <p class="text-xs text-zinc-800 mt-0.5 line-clamp-2 leading-snug">
                                {{ r.executive_summary || r.activities_performed }}
                            </p>
                        </div>
                        <span [ngClass]="normalizeZone(r.zone_type) === 'Urbana'
                                ? 'bg-emerald-50 text-emerald-700'
                                : 'bg-indigo-50 text-indigo-700'"
                            class="text-[10px] font-medium px-1.5 py-0.5 rounded-md flex-shrink-0 mt-0.5">
                            {{ normalizeZone(r.zone_type) }}
                        </span>
                    </div>
                    <!-- Indicadores del reporte -->
                    <div *ngIf="r.indicator_values.length > 0"
                        class="flex flex-wrap gap-1 mt-1.5">
                        <span *ngFor="let iv of r.indicator_values.slice(0, 3)"
                            class="inline-flex items-center gap-1 bg-zinc-100 text-zinc-500
                                   text-[10px] px-1.5 py-0.5 rounded-md">
                            <span class="font-medium">{{ iv.indicator?.name ?? 'Indicador' }}:</span>
                            {{ formatIndicatorValue(iv.value) }}
                        </span>
                        <span *ngIf="r.indicator_values.length > 3"
                            class="text-[10px] text-zinc-400">
                            +{{ r.indicator_values.length - 3 }} más
                        </span>
                    </div>
                </div>
            </div>

        </div>
    </div>

</div>
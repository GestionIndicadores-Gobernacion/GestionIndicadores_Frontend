<div class="container-fluid">

    <h3 class="mb-3">
        {{ isEdit ? 'Editar Registro' : 'Crear Registro' }}
    </h3>

    <!-- LOADING -->
    <div *ngIf="loading" class="text-center my-5">
        <div class="spinner-border text-primary"></div>
    </div>

    <!-- FORM -->
    <form *ngIf="!loading" (ngSubmit)="save()">

        <!-- =========================
          SECCIN 1: DATOS GENERALES
         ========================== -->
        <div class="card mb-3">
            <div class="card-body">

                <h5 class="card-title mb-3">Datos del registro</h5>

                <div class="row g-3">

                    <!-- Municipio -->
                    <div class="col-md-4">
                        <label class="form-label">Municipio</label>
                        <select class="form-control" [(ngModel)]="form.municipio" name="municipio" required>
                            <option [ngValue]="null" disabled>Seleccionar municipio...</option>
                            <option *ngFor="let m of municipios" [ngValue]="m">
                                {{ m }}
                            </option>
                        </select>
                    </div>

                    <!-- Fecha -->
                    <div class="col-md-4">
                        <label class="form-label">Fecha</label>
                        <input type="date" class="form-control" [(ngModel)]="form.fecha" name="fecha" required>
                    </div>

                    <!-- Componente -->
                    <div class="col-md-4">
                        <label class="form-label">Componente</label>
                        <select class="form-control" [(ngModel)]="form.component_id" name="component_id"
                            (change)="onComponentChange()" required>
                            <option [ngValue]="null" disabled>Seleccionar componente...</option>
                            <option *ngFor="let c of components" [ngValue]="c.id">
                                {{ c.name }}
                            </option>
                        </select>
                    </div>

                    <!-- Indicador -->
                    <div class="col-md-4">
                        <label class="form-label">Indicador</label>
                        <select class="form-control" [(ngModel)]="form.indicator_id" name="indicator_id"
                            (change)="onIndicatorChange()" [disabled]="!form.component_id" required>
                            <option [ngValue]="null" disabled>
                                {{ form.component_id ? 'Seleccionar indicador...' : 'Seleccione primero un componente'
                                }}
                            </option>
                            <option *ngFor="let i of indicators" [ngValue]="i.id">
                                {{ i.name }}
                            </option>
                        </select>
                    </div>

                </div>
            </div>
        </div>

        <!-- =========================
          SECCIN 2: POBLACIN
         ========================== -->
        <div class="card mb-3">
            <div class="card-body">

                <h5 class="card-title mb-3">Poblaci贸n</h5>

                <!-- Chips tipo_poblacion -->
                <div class="mb-3">
                    <label class="form-label">Tipo de poblaci贸n</label>

                    <div class="d-flex flex-wrap gap-2 mb-2">
                        <span class="badge bg-primary d-flex align-items-center"
                            *ngFor="let t of tipoPoblacionChips; let i = index">
                            {{ t }}
                            <button type="button" class="btn-close btn-close-white btn-sm ms-2" aria-label="Eliminar"
                                (click)="removeTipoPoblacion(i)"></button>
                        </span>

                        <span *ngIf="!tipoPoblacionChips.length" class="text-muted">
                            No hay tipos de poblaci贸n agregados.
                        </span>
                    </div>

                    <div class="input-group">
                        <input type="text" class="form-control" [(ngModel)]="nuevoTipoPoblacion"
                            name="nuevoTipoPoblacion" placeholder="Agregar tipo de poblaci贸n (ej: Perros, Gatos)"
                            (keyup.enter)="addTipoPoblacion()">
                        <button type="button" class="btn btn-outline-primary" (click)="addTipoPoblacion()">
                            Agregar
                        </button>
                    </div>
                </div>

                <!-- Detalle poblacional si aplica -->
                <div *ngIf="selectedIndicator?.use_list && hasAllowedValues()">
                    <label class="form-label">Detalle por tipo de poblaci贸n</label>

                    <div class="table-responsive">
                        <table class="table table-sm align-middle">
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Cantidad</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let val of selectedIndicator?.allowed_values">
                                    <td>{{ val }}</td>
                                    <td style="max-width: 120px;">
                                        <input type="number" min="0" class="form-control form-control-sm"
                                            [(ngModel)]="detallePoblacion[val]" name="detalle_{{ val }}">
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <small class="text-muted">
                        Solo se permiten claves definidas en el indicador.
                    </small>
                </div>

            </div>
        </div>

        <!-- =========================
          SECCIN 3: VALOR DEL INDICADOR
         ========================== -->
        <div class="card mb-3" *ngIf="selectedIndicator">
            <div class="card-body">
                <h5 class="card-title mb-3">
                    Valor del indicador
                    <span class="badge bg-secondary ms-2">
                        {{ selectedIndicator.data_type }}
                    </span>
                </h5>

                <!-- BOOLEAN -->
                <div *ngIf="isBooleanIndicator()">
                    <label class="form-label">Valor</label>
                    <select class="form-control" [(ngModel)]="form.valor" name="valor_boolean">
                        <option value="">Seleccionar...</option>
                        <option value="true">S铆</option>
                        <option value="false">No</option>
                    </select>
                </div>

                <!-- INTEGER -->
                <div *ngIf="isIntegerIndicator()">
                    <label class="form-label">Valor</label>
                    <input type="number" class="form-control" [(ngModel)]="form.valor" name="valor_integer">
                </div>

                <!-- DECIMAL -->
                <div *ngIf="isDecimalIndicator()">
                    <label class="form-label">Valor</label>
                    <input type="number" step="0.01" class="form-control" [(ngModel)]="form.valor" name="valor_decimal">
                </div>

                <!-- TEXT -->
                <div *ngIf="isTextIndicator()">
                    <label class="form-label">Valor</label>
                    <textarea class="form-control" rows="3" [(ngModel)]="form.valor" name="valor_text"></textarea>
                </div>

                <!-- DATE -->
                <div *ngIf="isDateIndicator()">
                    <label class="form-label">Valor</label>
                    <input type="date" class="form-control" [(ngModel)]="form.valor" name="valor_date">
                </div>

                <!-- CATEGORY -->
                <div *ngIf="isCategoryIndicator()">
                    <label class="form-label">Valor</label>

                    <ng-container *ngIf="hasAllowedValues(); else categoryText">
                        <select class="form-control" [(ngModel)]="form.valor" name="valor_category">
                            <option value="">Seleccionar...</option>
                            <option *ngFor="let v of selectedIndicator?.allowed_values" [value]="v">
                                {{ v }}
                            </option>
                        </select>
                    </ng-container>

                    <ng-template #categoryText>
                        <input type="text" class="form-control" [(ngModel)]="form.valor" name="valor_category_text"
                            placeholder="Valor de categor铆a">
                    </ng-template>
                </div>

                <small class="text-muted d-block mt-2">
                    El tipo de control se ajusta autom谩ticamente seg煤n el tipo de dato del indicador.
                </small>
            </div>
        </div>

        <!-- =========================
          SECCIN 4: EVIDENCIA
         ========================== -->
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title mb-3">Evidencia</h5>

                <div class="mb-3">
                    <label class="form-label">URL de evidencia (opcional)</label>
                    <input type="url" class="form-control" [(ngModel)]="form.evidencia_url" name="evidencia_url"
                        placeholder="https://...">
                </div>
            </div>
        </div>

        <!-- BOTONES -->
        <button class="btn btn-primary" [disabled]="saving">
            {{ saving ? 'Guardando...' : (isEdit ? 'Actualizar' : 'Crear Registro') }}
        </button>

        <button type="button" class="btn btn-secondary ms-2" (click)="cancel()">
            Cancelar
        </button>

    </form>

</div>
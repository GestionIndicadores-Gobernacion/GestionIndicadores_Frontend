<div class="record-form-container">

  <h2 class="page-title">
    {{ isEdit ? 'Editar informe' : 'Crear Informe' }}
  </h2>

  <!-- LOADING -->
  <div *ngIf="loading" class="loading-box">
    <div class="spinner"></div>
  </div>

  <form *ngIf="!loading" (ngSubmit)="onSubmit($event)">


    <!-- =====================================================
         ðŸ“Œ SecciÃ³n 1 â€” Datos generales
    ====================================================== -->
    <div class="form-section">
      <h3 class="section-title">Datos generales</h3>

      <div class="form-grid">

        <!-- Estrategia -->
        <div class="form-group">
          <label>Estrategia</label>

          <select [(ngModel)]="form.strategy_id" name="strategy_id" required (change)="onStrategyChange()"
            [class.invalid]="attemptedSubmit && !form.strategy_id">

            <option disabled [ngValue]="null">
              Seleccionar estrategia...
            </option>

            <option *ngFor="let s of strategies" [ngValue]="s.id">
              {{ s.name }}
            </option>
          </select>

          <div class="error-message" *ngIf="attemptedSubmit && !form.strategy_id">
            La estrategia es obligatoria.
          </div>
        </div>

        <!-- Actividad -->
        <div class="form-group">
          <label>Actividad</label>

          <select [(ngModel)]="form.activity_id" name="activity_id" required (change)="onActivityChange()"
            [disabled]="!form.strategy_id" [class.invalid]="attemptedSubmit && !form.activity_id">

            <option disabled [ngValue]="null">
              {{ form.strategy_id ? 'Seleccionar actividad...' : 'Seleccione una estrategia' }}
            </option>

            <option *ngFor="let a of activities" [ngValue]="a.id">
              {{ a.description }}
            </option>
          </select>

          <div class="error-message" *ngIf="attemptedSubmit && !form.activity_id">
            La actividad es obligatoria.
          </div>
        </div>

        <!-- Componente -->
        <div class="form-group">
          <label>Componente</label>

          <select [(ngModel)]="form.component_id" name="component_id" required (change)="onComponentChange()"
            [disabled]="!form.activity_id" [class.invalid]="attemptedSubmit && !form.component_id">

            <option disabled [ngValue]="null">
              {{ form.activity_id ? 'Seleccionar componente...' : 'Seleccione una actividad' }}
            </option>

            <option *ngFor="let c of components" [ngValue]="c.id">
              {{ c.name }}
            </option>
          </select>

          <div class="error-message" *ngIf="attemptedSubmit && !form.component_id">
            El componente es obligatorio.
          </div>
        </div>

      </div>
    </div>

    <!-- =====================================================
         ðŸ“Œ SecciÃ³n 2 â€” Reporte de indicadores KPI
    ====================================================== -->
    <div class="form-section">
      <h3 class="section-title">Reporte de indicadores KPI</h3>

      <div class="empty-text">
        En este campo reporte los avances cuantitativos del componente por municipio.
      </div>

      <div class="form-grid-dos two-columns">

        <!-- Resumen -->
        <div class="form-group">
          <label>Resumen ejecutivo</label>

          <textarea rows="4" maxlength="500" [(ngModel)]="form.description" name="description" required
            [class.invalid]="attemptedSubmit && !form.description"></textarea>

          <div class="char-counter">
            {{ form.description.length || 0 }}/500
          </div>

          <div class="error-message" *ngIf="attemptedSubmit && !form.description">
            El resumen es obligatorio.
          </div>
        </div>

        <!-- Actividades -->
        <div class="form-group">
          <label>Actividades realizadas</label>

          <textarea rows="4" maxlength="500" [(ngModel)]="form.actividades_realizadas" name="actividades_realizadas"
            required [class.invalid]="attemptedSubmit && !form.actividades_realizadas"></textarea>

          <div class="char-counter">
            {{ form.actividades_realizadas.length || 0 }}/500
          </div>

          <div class="error-message" *ngIf="attemptedSubmit && !form.actividades_realizadas">
            Campo obligatorio.
          </div>
        </div>

      </div>

      <!-- Municipios -->
      <app-multi-select label="Municipios" [items]="municipios" [(selected)]="selectedMunicipios"
        (selectedChange)="onMunicipiosChange()" [disabled]="!form.component_id">
      </app-multi-select>

      <div class="error-message" *ngIf="attemptedSubmit && !hasMunicipios()">
        Debes seleccionar al menos un municipio.
      </div>


      <div *ngFor="let municipio of selectedMunicipios" class="municipio-block">
        <h4>{{ municipio }}</h4>

        <table class="inner-table">
          <tr *ngFor="let ind of indicators">
            <td>
              {{ ind.name }}
              <span class="meta-tag">
                {{ ind.acumulado || 0 }}/{{ ind.meta }}
              </span>

            </td>

            <td>
              <input type="number" min="0" [max]="ind.meta"
                [(ngModel)]="detallePoblacion.municipios[municipio].indicadores[ind.name]"
                name="ind_{{municipio}}_{{ind.id}}" (input)="validateIndicadorValue(municipio, ind)">
            </td>
          </tr>

        </table>
      </div>
    </div>

    <!-- Evidencia -->
    <!-- Evidencia -->
    <div class="form-section">
      <h3 class="section-title">Evidencia</h3>

      <div class="form-group full">
        <input type="url" [(ngModel)]="form.evidencia_url" name="evidencia_url" placeholder="https://..."
          class="full-input">
      </div>
    </div>


    <!-- Botones -->
    <div class="form-actions">
      <button class="btn-primary" [disabled]="saving">
        {{ saving ? 'Guardando...' : (isEdit ? 'Actualizar' : 'Crear') }}
      </button>

      <button type="button" class="btn-secondary" (click)="cancel()">
        Cancelar
      </button>
    </div>

  </form>
</div>
<div class="record-form-container">

    <h2 class="page-title">
        {{ isEdit ? 'Editar Registro' : 'Crear Registro' }}
    </h2>

    <!-- Loading -->
    <div *ngIf="loading" class="loading-box">
        <div class="spinner"></div>
    </div>

    <form *ngIf="!loading" (ngSubmit)="save()">

        <!-- ============================
     üìå SECCI√ìN 1 ‚Äî DATOS GENERALES
     ============================ -->
        <div class="form-section">
            <h3 class="section-title">Datos del registro</h3>

            <div class="form-grid">

                <!-- Municipio -->
                <div class="form-group">
                    <label>Municipio</label>
                    <select [(ngModel)]="form.municipio" name="municipio" required>
                        <option disabled [ngValue]="null">Seleccionar municipio...</option>
                        <option *ngFor="let m of municipios" [ngValue]="m">{{ m }}</option>
                    </select>
                </div>

                <!-- Fecha -->
                <div class="form-group">
                    <label>Fecha</label>
                    <input type="date" [(ngModel)]="form.fecha" name="fecha" required>
                </div>

                <!-- Componente -->
                <div class="form-group">
                    <label>Componente</label>
                    <select [(ngModel)]="form.component_id" name="component_id" (change)="onComponentChange()" required>
                        <option disabled [ngValue]="null">Seleccionar componente...</option>
                        <option *ngFor="let c of components" [ngValue]="c.id">{{ c.name }}</option>
                    </select>
                </div>

                <!-- Indicador -->
                <div class="form-group">
                    <label>Indicador</label>
                    <select [(ngModel)]="form.indicator_id" name="indicator_id" (change)="onIndicatorChange()"
                        [disabled]="!form.component_id" required>
                        <option disabled [ngValue]="null">
                            {{ form.component_id ? 'Seleccionar indicador...' : 'Seleccione primero un componente' }}
                        </option>
                        <option *ngFor="let i of indicators" [ngValue]="i.id">{{ i.name }}</option>
                    </select>
                </div>

            </div>
        </div>

        <!-- ============================
     üìå SECCI√ìN 2 ‚Äî POBLACI√ìN
     ============================ -->
        <div class="form-section" [class.disabled-section]="!datosGeneralesCompletos">
            <h3 class="section-title">Poblaci√≥n</h3>

            <!-- Chips -->
            <div class="form-group full">
                <label>Tipo de poblaci√≥n</label>

                <div class="chips">
                    <span class="chip" *ngFor="let t of tipoPoblacionChips; let i = index">
                        {{ t }}
                        <button type="button" class="chip-close" (click)="removeTipoPoblacion(i)">‚úï</button>
                    </span>

                    <span *ngIf="!tipoPoblacionChips.length" class="empty-text">
                        No hay tipos de poblaci√≥n agregados.
                    </span>
                </div>

                <!-- <div class="chips-input">
                    <input type="text" [(ngModel)]="nuevoTipoPoblacion" name="nuevoTipoPoblacion"
                        placeholder="Agregar tipo de poblaci√≥n (ej: Perros, Gatos)" (keyup.enter)="addTipoPoblacion()">

                    <button type="button" class="btn-outline-primary" (click)="addTipoPoblacion()">
                        Agregar
                    </button>
                </div> -->
            </div>

            <!-- Detalle poblacional -->
            <div class="form-group full" *ngIf="selectedIndicator?.use_list && hasAllowedValues()">

                <label>Detalle por tipo de poblaci√≥n</label>

                <table class="inner-table">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Cantidad</th>
                        </tr>
                    </thead>

                    <tbody>
                        <tr *ngFor="let tipo of tipoPoblacionChips">
                            <td>{{ tipo }}</td>
                            <td>
                                <input type="number" min="0" [(ngModel)]="detallePoblacion[tipo]"
                                    name="detalle_{{ tipo }}">
                            </td>
                        </tr>

                    </tbody>
                </table>

                <small class="help-text">
                    Solo se permiten claves definidas en el indicador.
                </small>
            </div>

        </div>

        <!-- ============================
     üìå SECCI√ìN 3 ‚Äî VALOR
     ============================ -->
        <div class="form-section" *ngIf="selectedIndicator" [class.disabled-section]="!datosGeneralesCompletos">
            <h3 class="section-title">
                Valor del indicador
                <span class="tag">{{ selectedIndicator.data_type }}</span>
            </h3>

            <div class="form-group full">

                <!-- BOOLEAN -->
                <ng-container *ngIf="isBooleanIndicator()">
                    <label>Valor</label>
                    <select [(ngModel)]="form.valor" name="valor_bool">
                        <option value="">Seleccionar...</option>
                        <option value="true">S√≠</option>
                        <option value="false">No</option>
                    </select>
                </ng-container>

                <!-- INTEGER -->
                <ng-container *ngIf="isIntegerIndicator()">
                    <label>Valor</label>
                    <input type="number" [(ngModel)]="form.valor" name="valor_int">
                </ng-container>

                <!-- DECIMAL -->
                <ng-container *ngIf="isDecimalIndicator()">
                    <label>Valor</label>
                    <input type="number" step="0.01" [(ngModel)]="form.valor" name="valor_decimal">
                </ng-container>

                <!-- TEXT -->
                <ng-container *ngIf="isTextIndicator()">
                    <label>Valor</label>
                    <textarea rows="3" [(ngModel)]="form.valor" name="valor_text"></textarea>
                </ng-container>

                <!-- DATE -->
                <ng-container *ngIf="isDateIndicator()">
                    <label>Valor</label>
                    <input type="date" [(ngModel)]="form.valor" name="valor_date">
                </ng-container>

                <!-- CATEGORY -->
                <ng-container *ngIf="isCategoryIndicator()">

                    <label>Valor</label>

                    <ng-container *ngIf="hasAllowedValues(); else textValue">
                        <select [(ngModel)]="form.valor" name="valor_cat">
                            <option value="">Seleccionar...</option>
                            <option *ngFor="let v of selectedIndicator?.allowed_values" [value]="v">{{ v }}</option>
                        </select>
                    </ng-container>

                    <ng-template #textValue>
                        <input type="text" [(ngModel)]="form.valor" name="valor_cat_text"
                            placeholder="Valor de categor√≠a">
                    </ng-template>
                </ng-container>

            </div>

            <small class="help-text">
                El tipo de control se ajusta autom√°ticamente seg√∫n el tipo de dato del indicador.
            </small>
        </div>

        <!-- ============================
     üìå SECCI√ìN 4 ‚Äî EVIDENCIA
     ============================ -->
        <div class="form-section" [class.disabled-section]="!datosGeneralesCompletos">
            <h3 class="section-title">Evidencia</h3>

            <div class="form-group full">
                <label>URL de evidencia (opcional)</label>
                <input type="url" [(ngModel)]="form.evidencia_url" name="evidencia_url" placeholder="https://...">
            </div>
        </div>

        <!-- BOTONES -->
        <div class="form-actions">
            <button class="btn-primary" [disabled]="saving">
                {{ saving ? 'Guardando...' : (isEdit ? 'Actualizar' : 'Crear Registro') }}
            </button>

            <button type="button" class="btn-secondary" (click)="cancel()">
                Cancelar
            </button>
        </div>

    </form>

</div>
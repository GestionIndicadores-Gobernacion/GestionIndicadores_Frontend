<div class="records-container">

  <div class="records-header">
    <h2>Gestión de Registros</h2>

    <div class="header-actions">
      <button class="btn-export" (click)="exportToExcel()">
        Exportar Excel
      </button>

      <button *ngIf="!isViewer" class="btn-primary" routerLink="/dashboard/records/create">
        Crear Registro
      </button>
    </div>
  </div>

  <!-- BUSCADOR -->
  <div class="search-box">
    <input type="text" placeholder="Buscar por componente, indicador o municipio..." [(ngModel)]="search"
      (input)="applyFilter()" />
  </div>

  <div *ngIf="!loading" class="table-wrapper">

    <!-- SIN REGISTROS -->
    <div *ngIf="paginatedRecords.length === 0" class="empty-state">
      <p>No hay registros disponibles.</p>
    </div>

    <!-- TABLA -->
    <table *ngIf="paginatedRecords.length > 0" class="custom-table">

      <thead>
        <tr>
          <th (click)="sortBy('id')">ID</th>
          <th (click)="sortBy('strategy')">Estrategia</th>
          <th (click)="sortBy('activity')">Actividad</th>
          <th (click)="sortBy('component')">Componente</th>
          <th (click)="sortBy('indicator')">Indicadores</th>
          <th (click)="sortBy('municipio')">Municipios</th>
          <th (click)="sortBy('fecha')">Fecha</th>
          <th class="text-center">Acciones</th>
        </tr>
      </thead>


      <tbody>
        <tr *ngFor="let r of paginatedRecords">

          <td>{{ r.id }}</td>

          <td>{{ strategyMap[r.strategy_id] }}</td>

          <td class="actividad-cell" [title]="activityMap[r.activity_id]">
            {{ getShortActivity(activityMap[r.activity_id]) }}
          </td>


          <td>{{ componentMap[r.component_id] }}</td>


          <!-- INDICADORES (NUEVO MODELO) -->
          <td>
            <div *ngFor="let name of getIndicatorNames(r)">
              <b>{{ name }}</b>
            </div>
          </td>

          <td>
            {{ getMunicipios(r).join(', ') || '—' }}
          </td>

          <td>{{ r.fecha | date }}</td>

          <td class="actions-col">

            <button class="btn-outline" [routerLink]="['/dashboard/records', r.id]">
              Ver
            </button>

            <button *ngIf="!isViewer" class="btn-outline-primary" [routerLink]="['/dashboard/records', r.id, 'edit']">
              Editar
            </button>

            <button *ngIf="!isViewer" class="btn-outline-danger" (click)="deleteRecord(r.id)">
              Eliminar
            </button>
          </td>
        </tr>
      </tbody>

    </table>

    <!-- PAGINACIÓN -->
    <div class="pagination-container" *ngIf="totalPages > 1">

      <button class="page-btn" [disabled]="currentPage === 1" (click)="currentPage = currentPage - 1">
        ◀
      </button>

      <span class="page-info">
        Página {{ currentPage }} de {{ totalPages }}
      </span>

      <button class="page-btn" [disabled]="currentPage === totalPages" (click)="currentPage = currentPage + 1">
        ▶
      </button>

    </div>

  </div>

</div>
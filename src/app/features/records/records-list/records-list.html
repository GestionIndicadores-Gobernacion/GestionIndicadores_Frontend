<div class="records-container">

  <div class="records-header">
    <h2>Gestión de Registros</h2>
    <button *ngIf="!isViewer" class="btn-primary" routerLink="/dashboard/records/create">Crear Registro</button>
  </div>

  <div class="search-box">
    <input type="text" placeholder="Buscar por componente, indicador o municipio..." [(ngModel)]="search"
      (input)="applyFilter()" />
  </div>


  <div *ngIf="!loading" class="table-wrapper">
    <table class="custom-table">

      <thead>
        <tr>
          <th (click)="sortBy('id')" class="sortable">
            ID
            <span *ngIf="sortColumn === 'id'">{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
          </th>

          <th (click)="sortBy('component')" class="sortable">
            Componente
            <span *ngIf="sortColumn === 'component'">{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
          </th>

          <th (click)="sortBy('indicator')" class="sortable">
            Indicador
            <span *ngIf="sortColumn === 'indicator'">{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
          </th>

          <th (click)="sortBy('municipio')" class="sortable">
            Municipio
            <span *ngIf="sortColumn === 'municipio'">{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
          </th>

          <th (click)="sortBy('fecha')" class="sortable">
            Fecha
            <span *ngIf="sortColumn === 'fecha'">{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
          </th>

          <th (click)="sortBy('tipo_poblacion')" class="sortable">
            Tipo población
            <span *ngIf="sortColumn === 'tipo_poblacion'">{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
          </th>

          <th class="text-center">Acciones</th>
        </tr>
      </thead>


      <tbody>
        <tr *ngFor="let r of paginatedRecords">

          <td>{{ r.id }}</td>
          <td>{{ componentMap[r.component_id ?? 0] || '—' }}</td>
          <td>{{ indicatorMap[r.indicator_id ?? 0] || '—' }}</td>
          <td>{{ r.municipio }}</td>
          <td>{{ r.fecha | date }}</td>

          <td>
            <ng-container *ngIf="r.tipo_poblacion as tp">
              <span *ngIf="tp.length">{{ tp.join(', ') }}</span>
            </ng-container>
          </td>

          <td class="actions-col">

            <button class="btn-outline" [routerLink]="['/dashboard/records', r.id]">
              Ver
            </button>

            <button *ngIf="!isViewer" class="btn-outline-primary" [routerLink]="['/dashboard/records', r.id, 'edit']">
              Editar
            </button>

            <button *ngIf="!isViewer" class="btn-outline-danger" (click)="deleteRecord(r.id)">
              Eliminar
            </button>

          </td>

        </tr>
      </tbody>

    </table>

    <div class="pagination-container" *ngIf="totalPages > 1">

      <button class="page-btn" [disabled]="currentPage === 1" (click)="currentPage = currentPage - 1">
        ◀
      </button>

      <span class="page-info">
        Página {{ currentPage }} de {{ totalPages }}
      </span>

      <button class="page-btn" [disabled]="currentPage === totalPages" (click)="currentPage = currentPage + 1">
        ▶
      </button>

    </div>

  </div>

</div>